name: Auto tag bootstrapper release

on:
  push:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: "auto-release-bootstrapper"
  cancel-in-progress: false

jobs:
  tag:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide whether to tag a release
        id: decide
        shell: bash
        run: |
          set -euo pipefail

          SHA="${GITHUB_SHA}"
          BEFORE="${{ github.event.before }}"

          # Allow an explicit opt-out for "unstable" pushes to main.
          MSG="$(git log -1 --pretty=%B "$SHA")"
          if echo "$MSG" | rg -q "\\[no-release\\]" ; then
            echo "reason=commit message opted out ([no-release])" >> "$GITHUB_OUTPUT"
            echo "should_tag=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Determine what changed in this push.
          if [[ -n "$BEFORE" && "$BEFORE" != "0000000000000000000000000000000000000000" ]]; then
            CHANGED="$(git diff --name-only "$BEFORE" "$SHA" || true)"
          else
            CHANGED="$(git diff --name-only "${SHA}^" "$SHA" 2>/dev/null || true)"
          fi

          # Only auto-tag when user-facing distribution changes.
          # This keeps releases from being created for unrelated edits.
          if echo "$CHANGED" | rg -q '^(crates/makimono/|install\\.sh|install\\.ps1|\\.github/workflows/release-bootstrapper\\.yml)'; then
            echo "reason=bootstrapper/distribution files changed" >> "$GITHUB_OUTPUT"
            echo "should_tag=true" >> "$GITHUB_OUTPUT"
          else
            echo "reason=no bootstrapper/distribution changes detected" >> "$GITHUB_OUTPUT"
            echo "should_tag=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Tag next patch release
        if: steps.decide.outputs.should_tag == 'true'
        shell: bash
        run: |
          set -euo pipefail

          # If this commit is already tagged with a makimono-x.y.z tag, do nothing.
          if git tag --points-at "$GITHUB_SHA" | rg -q '^makimono-[0-9]+\\.[0-9]+\\.[0-9]+$'; then
            echo "commit already has a bootstrapper semver tag; skipping"
            exit 0
          fi

          latest="$(git tag -l 'makimono-[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -n 1 || true)"
          if [[ -z "$latest" ]]; then
            next="makimono-0.1.0"
          else
            ver="${latest#makimono-}"
            IFS=. read -r major minor patch <<<"$ver"
            patch="$((patch+1))"
            next="makimono-${major}.${minor}.${patch}"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$next" -m "Makimono bootstrapper $next" "$GITHUB_SHA"
          git push origin "$next"

          echo "created tag: $next"
