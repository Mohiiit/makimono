name: Auto tag bootstrapper release

on:
  push:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: "auto-release-bootstrapper"
  cancel-in-progress: false

jobs:
  tag:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide whether to tag a release
        id: decide
        shell: bash
        run: |
          set -euo pipefail

          SHA="${GITHUB_SHA}"
          BEFORE="${{ github.event.before }}"

          # Allow an explicit opt-out for "unstable" pushes to main.
          MSG="$(git log -1 --pretty=%B "$SHA")"
          if echo "$MSG" | grep -Eq "\\[no-release\\]" ; then
            echo "reason=commit message opted out ([no-release])" >> "$GITHUB_OUTPUT"
            echo "should_tag=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Read the bootstrapper version from Cargo.toml (workspace.package.version).
          # Avoid tomllib/tomli dependency differences across GitHub runner images.
          ver_now="$(
            python3 - <<'PY'
import re
from pathlib import Path

txt = Path("Cargo.toml").read_text(encoding="utf-8")
in_section = False
for line in txt.splitlines():
    s = line.strip()
    if s == "[workspace.package]":
        in_section = True
        continue
    if in_section and s.startswith("[") and s.endswith("]"):
        break
    if in_section:
        m = re.match(r'^version\\s*=\\s*"([^"]+)"\\s*$', s)
        if m:
            print(m.group(1))
            raise SystemExit(0)
raise SystemExit("version not found under [workspace.package]")
PY
          )"

          # Determine what changed in this push.
          if [[ -n "$BEFORE" && "$BEFORE" != "0000000000000000000000000000000000000000" ]]; then
            CHANGED="$(git diff --name-only "$BEFORE" "$SHA" || true)"
          else
            CHANGED="$(git diff --name-only "${SHA}^" "$SHA" 2>/dev/null || true)"
          fi

          # Only auto-tag when the Cargo.toml version was bumped in this push.
          if echo "$CHANGED" | grep -Eq '^Cargo\\.toml$'; then
            # Compare previous version to current version.
            if [[ -n "$BEFORE" && "$BEFORE" != "0000000000000000000000000000000000000000" ]]; then
              ver_before="$(
                git show "${BEFORE}:Cargo.toml" | python3 - <<'PY'
import re, sys
txt = sys.stdin.read()
in_section = False
for line in txt.splitlines():
    s = line.strip()
    if s == "[workspace.package]":
        in_section = True
        continue
    if in_section and s.startswith("[") and s.endswith("]"):
        break
    if in_section:
        m = re.match(r'^version\\s*=\\s*"([^"]+)"\\s*$', s)
        if m:
            print(m.group(1))
            raise SystemExit(0)
print("")
PY
              )"
            else
              ver_before=""
            fi

            if [[ -n "$ver_before" && "$ver_before" == "$ver_now" ]]; then
              echo "reason=Cargo.toml changed but version did not bump ($ver_now)" >> "$GITHUB_OUTPUT"
              echo "should_tag=false" >> "$GITHUB_OUTPUT"
            else
              echo "reason=version bump detected ($ver_before -> $ver_now)" >> "$GITHUB_OUTPUT"
              echo "should_tag=true" >> "$GITHUB_OUTPUT"
              echo "version=$ver_now" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "reason=no Cargo.toml change; no version bump to release" >> "$GITHUB_OUTPUT"
            echo "should_tag=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Tag bootstrapper release (from Cargo.toml version)
        if: steps.decide.outputs.should_tag == 'true'
        shell: bash
        run: |
          set -euo pipefail

          VER="${{ steps.decide.outputs.version }}"
          if [[ -z "$VER" ]]; then
            echo "missing version output from decide step" >&2
            exit 1
          fi
          next="makimono-${VER}"

          # If this commit is already tagged with a makimono-x.y.z tag, do nothing.
          if git tag --points-at "$GITHUB_SHA" | grep -Eq '^makimono-[0-9]+\\.[0-9]+\\.[0-9]+$'; then
            echo "commit already has a bootstrapper semver tag; skipping"
            exit 0
          fi

          # If the tag already exists, do nothing.
          if git rev-parse -q --verify "refs/tags/$next" >/dev/null; then
            echo "tag already exists: $next"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$next" -m "Makimono bootstrapper $next" "$GITHUB_SHA"
          git push origin "$next"

          echo "created tag: $next"
